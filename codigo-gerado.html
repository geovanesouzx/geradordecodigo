<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Código com IA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <link id="hljs-theme" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <style>
        :root {
            --bg: #111827; --panel-bg: #1f2937; --border: #374151;
            --text-primary: #f9fafb; --text-secondary: #9ca3af; --accent: #4f46e5;
        }
        body.light {
            --bg: #f3f4f6; --panel-bg: #ffffff; --border: #e5e7eb;
            --text-primary: #111827; --text-secondary: #6b7280; --accent: #4f46e5;
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg); color: var(--text-primary); }
        .panel { background-color: var(--panel-bg); border: 1px solid var(--border); }
        .input-area { background-color: var(--panel-bg); border: 1px solid var(--border); }
        .text-secondary { color: var(--text-secondary); }
        .border-color { border-color: var(--border); }
        .hover-bg:hover { background-color: rgba(255,255,255,0.1); }
        body.light .hover-bg:hover { background-color: rgba(0,0,0,0.05); }
        
        #code-editor::-webkit-scrollbar { width: 8px; }
        #code-editor::-webkit-scrollbar-track { background: transparent; }
        #code-editor::-webkit-scrollbar-thumb { background-color: #4b5563; border-radius: 4px; }
        
        select { -webkit-appearance: none; -moz-appearance: none; appearance: none; background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%239ca3af' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); background-position: right 0.75rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em; padding-right: 2.5rem; }
        body.light select { background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); }
        select option, select optgroup { background: var(--bg); color: var(--text-primary); }
        .skeleton-line { background-color: rgba(255,255,255,0.1); border-radius: 0.25rem; }
        body.light .skeleton-line { background-color: rgba(0,0,0,0.1); }
        #code-editor { font-family: monospace; font-size: 0.875rem; line-height: 1.25rem; background: transparent; color: var(--text-primary); resize: none; }
    </style>
</head>
<body class="antialiased transition-colors duration-300">

    <div class="flex flex-col md:flex-row h-screen">
        <!-- PAINEL DE CONTROLO (ESQUERDA) -->
        <div class="w-full md:w-1/2 lg:w-1/3 flex flex-col p-4 md:p-6 space-y-6 panel border-t-0 border-l-0 border-b-0">
            <header class="flex justify-between items-center">
                <div class="flex items-center space-x-2">
                    <svg class="w-8 h-8 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M14.25 9.75L16.5 12l-2.25 2.25m-4.5 0L7.5 12l2.25-2.25M6 20.25h12A2.25 2.25 0 0020.25 18V5.75A2.25 2.25 0 0018 3.5H6A2.25 2.25 0 003.75 5.75v12.5A2.25 2.25 0 006 20.25z" /></svg>
                    <h1 class="text-xl font-bold">Gerador de Código</h1>
                </div>
                <div class="flex space-x-2">
                    <button id="theme-toggle-btn" class="p-2 rounded-full hover-bg transition"><svg id="sun-icon" class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" /></svg><svg id="moon-icon" class="w-5 h-5 hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25c0 5.385 4.365 9.75 9.75 9.75 2.597 0 4.962-.992 6.75-2.625z" /></svg></button>
                    <button id="history-toggle-btn" class="p-2 rounded-full hover-bg transition"><svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></button>
                </div>
            </header>

            <div class="flex-grow flex flex-col space-y-4">
                <div>
                    <label for="language" class="block text-sm font-medium mb-2 text-secondary">Linguagem</label>
                    <select id="language" class="w-full text-base input-area rounded-lg px-4 py-2 focus:ring-2 focus:ring-indigo-500 focus:outline-none transition">
                       <optgroup label="Web"><option value="web">HTML/CSS/JS</option><option value="html">HTML</option><option value="css">CSS</option><option value="javascript">JavaScript</option></optgroup>
                       <optgroup label="Back-end"><option value="python">Python</option><option value="java">Java</option><option value="go">Go</option><option value="php">PHP</option><option value="ruby">Ruby</option></optgroup>
                       <optgroup label="Base de Dados"><option value="sql">SQL</option></optgroup>
                    </select>
                </div>
                <div class="flex-grow flex flex-col">
                    <div class="flex justify-between items-center mb-2">
                        <label for="prompt" class="text-sm font-medium text-secondary">Pedido</label>
                        <div class="flex items-center space-x-3">
                            <button id="mic-btn" title="Usar Voz" class="text-secondary hover:text-primary transition"><svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 18.75a6 6 0 006-6v-1.5m-6 7.5a6 6 0 01-6-6v-1.5m12 7.5v-1.5a6 6 0 00-6-6v-1.5a6 6 0 00-6 6v1.5m6 6v-1.5m0-15V5.25A2.25 2.25 0 0112 3a2.25 2.25 0 012.25 2.25v.008" /></svg></button>
                            <button id="suggest-btn" title="Sugerir uma ideia" class="text-secondary hover:text-primary transition"><svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 18v-5.25m0 0a6.01 6.01 0 001.5-.189m-1.5.189a6.01 6.01 0 01-1.5-.189m3.75 7.478a12.06 12.06 0 01-4.5 0m3.75 2.311a14.994 14.994 0 01-3.75 0m-1.013-1.412a7.25 7.25 0 012.25 0m-2.25 0a7.25 7.25 0 00-2.25 0M12 3c-1.892 0-3.758.468-5.455 1.362a14.969 14.969 0 00-3.048 3.048C2.468 8.242 2 10.108 2 12s.468 3.758 1.362 5.455a14.969 14.969 0 003.048 3.048c1.697.894 3.563 1.362 5.455 1.362s3.758-.468 5.455-1.362a14.969 14.969 0 003.048-3.048c.894-1.697 1.362-3.563 1.362-5.455s-.468-3.758-1.362-5.455a14.969 14.969 0 00-3.048-3.048A14.994 14.994 0 0012 3z" /></svg></button>
                            <button id="clear-prompt-btn" title="Limpar" class="text-secondary hover:text-primary transition"><svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9.75L14.25 12m0 0l2.25 2.25M14.25 12L12 14.25m-2.58 4.92l-6.375-6.375a1.125 1.125 0 010-1.59L9.42 4.83c.211-.211.498-.33.796-.33H19.5a2.25 2.25 0 012.25 2.25v10.5a2.25 2.25 0 01-2.25 2.25h-9.284c-.298 0-.585-.119-.796-.33z" /></svg></button>
                        </div>
                    </div>
                    <textarea id="prompt" rows="4" maxlength="500000" class="w-full h-full flex-grow text-base input-area rounded-lg px-4 py-2 focus:ring-2 focus:ring-indigo-500 focus:outline-none transition resize-none" placeholder="Ex: um cartão de perfil com foto e redes sociais"></textarea>
                    <p id="char-count" class="text-xs text-right mt-1 text-secondary">0/500000</p>
                </div>
                <div class="pt-2">
                    <button id="generate-btn" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 px-4 rounded-lg transition-all duration-300 flex items-center justify-center shadow-lg disabled:bg-indigo-400 disabled:cursor-not-allowed"><svg id="button-icon" class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09z" /></svg><span id="button-text">Gerar Código</span></button>
                    <button id="stop-btn" class="w-full bg-red-600 hover:bg-red-500 text-white font-bold py-3 px-4 rounded-lg transition-all duration-300 flex items-center justify-center shadow-lg hidden"><svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 3h18v18H3z" /></svg><span>Parar</span></button>
                </div>
            </div>
        </div>

        <!-- PAINEL DE RESULTADOS (DIREITA) -->
        <div id="result-container" class="w-full md:w-1/2 lg:w-2/3 flex flex-col h-full p-4 md:p-6">
             <div id="result-panel" class="panel rounded-2xl h-full flex-col hidden">
                <div id="result-header" class="px-6 py-4 border-b border-color flex justify-between items-center flex-shrink-0">
                    <h2 id="result-title" class="text-lg font-semibold">Código Gerado</h2>
                    <div class="flex items-center space-x-2">
                        <button id="explain-btn" title="Explicar Código" class="p-2 rounded-full hover-bg transition"><svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025 1.172 2.687 0 3.712-.203.179-.43.326-.67.442-.745.361-1.45.999-1.45 1.827v.75M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9 5.25h.008v.008H12v-.008z" /></svg></button>
                        <button id="optimize-btn" title="Otimizar Código" class="p-2 rounded-full hover-bg transition"><svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 13.5l10.5-11.25L12 10.5h8.25L9.75 21.75 12 13.5H3.75z" /></svg></button>
                        <button id="download-btn" title="Descarregar" class="p-2 rounded-full hover-bg transition"><svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" /></svg></button>
                        <button id="preview-toggle-btn" class="bg-sky-600 hover:bg-sky-500 text-white text-sm font-medium py-2 px-4 rounded-lg transition-colors flex items-center hidden">Executar Preview</button>
                        <button id="copy-btn" class="bg-indigo-600 hover:bg-indigo-500 text-white text-sm font-medium py-2 px-4 rounded-lg transition-colors flex items-center"><span id="copy-icon"><svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 7.5V6.108c0-1.135.845-2.098 1.976-2.192.373-.03.748-.03 1.125 0 1.131.094 1.976 1.057 1.976 2.192V7.5m-9 3c0-1.135.845-2.098 1.976-2.192a48.424 48.424 0 011.125 0c1.131.094 1.976 1.057 1.976 2.192V19.5A2.25 2.25 0 0118 21.75V10.5M15 12H9m12 3h-2.25M15 12H9" /></svg></span><span id="check-icon" class="hidden"><svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg></span><span id="copy-text" class="ml-2">Copiar</span></button>
                    </div>
                </div>
                <div id="code-pane" class="relative flex-grow h-0"><pre class="w-full h-full"><code id="code-editor" contenteditable="true" class="w-full h-full p-6 block overflow-auto outline-none"></code></pre></div>
                <div id="preview-pane" class="hidden bg-white rounded-b-2xl flex-grow h-0"><iframe id="preview-iframe" class="w-full h-full border-none rounded-b-2xl"></iframe></div>
                <div id="skeleton-loader" class="p-6 hidden animate-pulse flex-grow"><div class="space-y-3"><div class="h-4 skeleton-line w-3/4"></div><div class="h-4 skeleton-line"></div><div class="h-4 skeleton-line w-5/6"></div><div class="h-4 skeleton-line w-1/2"></div></div></div>
                <div id="stats-bar" class="px-6 py-2 border-t border-color text-xs text-secondary flex-shrink-0"></div>
                <div id="follow-up-container" class="px-6 py-4 border-t border-color hidden flex-shrink-0"><div class="flex space-x-2"><input id="follow-up-prompt" type="text" placeholder="Pedir uma modificação..." class="w-full text-sm input-area rounded-lg px-3 py-1.5 focus:ring-1 focus:ring-indigo-500 focus:outline-none transition"><button id="follow-up-btn" class="bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-1.5 px-3 rounded-lg transition">Enviar</button></div></div>
            </div>
            <div id="placeholder-panel" class="w-full h-full flex items-center justify-center panel rounded-2xl">
                <div class="text-center text-secondary">
                    <svg class="w-16 h-16 mx-auto mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M17.25 6.75L22.5 12l-5.25 5.25m-10.5 0L1.5 12l5.25-5.25m7.5-3l-4.5 16.5" /></svg>
                    <h2 class="text-xl font-medium">O seu código aparecerá aqui</h2>
                    <p>Preencha os campos à esquerda e clique em "Gerar Código".</p>
                </div>
            </div>
        </div>
    </div>

    <!-- PAINEL DE HISTÓRICO -->
    <div id="history-panel" class="fixed top-0 right-0 h-full w-80 md:w-96 panel shadow-2xl transform translate-x-full transition-transform duration-300 ease-in-out z-20 flex flex-col">
        <div class="p-4 border-b border-color flex justify-between items-center"><h3 class="text-lg font-semibold">Histórico</h3><button id="close-history-btn"><svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg></button></div>
        <div class="p-2"><input id="history-search" type="search" placeholder="Pesquisar histórico..." class="w-full text-sm input-area rounded-lg px-3 py-1.5 focus:ring-1 focus:ring-indigo-500 focus:outline-none transition"></div>
        <ul id="history-list" class="flex-grow overflow-y-auto p-2"></ul>
        <div class="p-4 border-t border-color"><button id="clear-history-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition">Limpar Histórico</button></div>
    </div>

    <div id="copy-feedback" class="fixed bottom-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-xl opacity-0 transition-opacity duration-500">Código copiado!</div>
    
    <script>
        // DOM Elements
        const $ = (selector) => document.getElementById(selector);
        const generateBtn = $('generate-btn'), stopBtn = $('stop-btn'), promptInput = $('prompt'), languageSelect = $('language');
        const resultContainer = $('result-container'), codeEditor = $('code-editor'), copyBtn = $('copy-btn'), downloadBtn = $('download-btn');
        const previewToggleBtn = $('preview-toggle-btn'), codePane = $('code-pane'), previewPane = $('preview-pane');
        const themeToggleBtn = $('theme-toggle-btn'), sunIcon = $('sun-icon'), moonIcon = $('moon-icon');
        const historyPanel = $('history-panel'), historyToggleBtn = $('history-toggle-btn'), closeHistoryBtn = $('close-history-btn');
        const historyList = $('history-list'), clearHistoryBtn = $('clear-history-btn'), historySearch = $('history-search');
        const suggestBtn = $('suggest-btn'), clearPromptBtn = $('clear-prompt-btn'), micBtn = $('mic-btn');
        const charCount = $('char-count'), skeletonLoader = $('skeleton-loader'), statsBar = $('stats-bar');
        const explainBtn = $('explain-btn'), optimizeBtn = $('optimize-btn');
        const followUpContainer = $('follow-up-container'), followUpPrompt = $('follow-up-prompt'), followUpBtn = $('follow-up-btn');
        const resultPanel = $('result-panel'), placeholderPanel = $('placeholder-panel');

        const webLanguages = ['html', 'javascript', 'css', 'web'];
        let history = [];
        const suggestions = ['um relógio digital com data', 'uma calculadora simples', 'um cartão de perfil de utilizador', 'um botão com gradiente animado', 'uma galeria de imagens lightbox', 'um formulário de contacto com validação', 'um leitor de música simples', 'uma barra de progresso animada', 'um menu de navegação responsivo', 'um gerador de senhas aleatórias', 'uma lista de tarefas (to-do list)', 'um conversor de unidades', 'um seletor de cores (color picker)', 'um ecrã de previsão do tempo', 'um acordeão (accordion) para FAQ'];
        let abortController;

        // Event Listeners
        generateBtn.addEventListener('click', handleGenerateClick);
        stopBtn.addEventListener('click', () => abortController?.abort());
        previewToggleBtn.addEventListener('click', () => previewPane.classList.contains('hidden') ? showPreview() : showCodeView());
        themeToggleBtn.addEventListener('click', toggleTheme);
        historyToggleBtn.addEventListener('click', () => historyPanel.classList.remove('translate-x-full'));
        closeHistoryBtn.addEventListener('click', () => historyPanel.classList.add('translate-x-full'));
        clearHistoryBtn.addEventListener('click', clearHistory);
        suggestBtn.addEventListener('click', suggestIdea);
        clearPromptBtn.addEventListener('click', () => { promptInput.value = ''; promptInput.dispatchEvent(new Event('input')); });
        promptInput.addEventListener('input', () => { const len = promptInput.value.length; charCount.textContent = `${len}/500000`; });
        historySearch.addEventListener('input', renderHistory);
        downloadBtn.addEventListener('click', downloadCode);
        micBtn.addEventListener('click', startSpeechRecognition);
        explainBtn.addEventListener('click', () => handleCodeAction('explain'));
        optimizeBtn.addEventListener('click', () => handleCodeAction('optimize'));
        followUpBtn.addEventListener('click', handleFollowUp);
        document.addEventListener('keydown', (e) => { if (e.ctrlKey && e.key === 'Enter' && !generateBtn.disabled) generateBtn.click(); });
        codeEditor.addEventListener('input', updateStats);

        // Initialization
        document.addEventListener('DOMContentLoaded', () => { loadTheme(); loadHistory(); });

        async function handleCodeAction(action) {
            const currentCode = codeEditor.textContent;
            if (!currentCode) return;
            let actionPrompt = '';
            if (action === 'explain') {
                actionPrompt = `Explique o seguinte código em detalhe, linha por linha:\n\n\`\`\`${languageSelect.value}\n${currentCode}\n\`\`\``;
            } else if (action === 'optimize') {
                actionPrompt = `Otimize o seguinte código para ser mais eficiente e moderno. Retorne apenas o código otimizado, sem explicações adicionais:\n\n\`\`\`${languageSelect.value}\n${currentCode}\n\`\`\``;
            }
            
            setLoadingState(true);
            codeEditor.textContent = '';
            codePane.classList.add('hidden');
            skeletonLoader.classList.remove('hidden');
            abortController = new AbortController();

            try {
                await generateContentStream(actionPrompt, abortController.signal, true);
            } catch (error) {
                if (error.name !== 'AbortError') codeEditor.textContent = 'Ocorreu um erro ao processar o pedido.';
            } finally {
                setLoadingState(false);
                codePane.classList.remove('hidden');
                skeletonLoader.classList.add('hidden');
            }
        }

        async function handleFollowUp() {
            const followUpText = followUpPrompt.value.trim();
            if (!followUpText) return;
            const currentCode = codeEditor.textContent;
            const followUpFullPrompt = `Dado o seguinte código:\n\n\`\`\`${languageSelect.value}\n${currentCode}\n\`\`\`\n\nPor favor, aplique a seguinte modificação: "${followUpText}". Retorne apenas o código modificado.`;
            
            setLoadingState(true);
            codeEditor.textContent = '';
            codePane.classList.add('hidden');
            skeletonLoader.classList.remove('hidden');
            abortController = new AbortController();
            followUpPrompt.value = '';

            try {
                await generateContentStream(followUpFullPrompt, abortController.signal);
            } catch (error) {
                if (error.name !== 'AbortError') codeEditor.textContent = 'Ocorreu um erro ao processar o pedido.';
            } finally {
                setLoadingState(false);
                codePane.classList.remove('hidden');
                skeletonLoader.classList.add('hidden');
            }
        }

        async function handleGenerateClick() {
            const userPrompt = promptInput.value.trim();
            const selectedLanguage = languageSelect.value;
            if (!userPrompt) { alert('Por favor, descreva o que o código deve fazer.'); return; }
            
            setLoadingState(true);
            resultPanel.classList.remove('hidden');
            placeholderPanel.classList.add('hidden');
            showCodeView();
            
            codeEditor.textContent = '';
            codePane.classList.add('hidden');
            skeletonLoader.classList.remove('hidden');

            previewToggleBtn.classList.toggle('hidden', !webLanguages.includes(selectedLanguage));
            abortController = new AbortController();

            try {
                let fullPrompt;
                if (selectedLanguage === 'web') {
                    fullPrompt = `Crie um trecho de código web completo que faça o seguinte: "${userPrompt}". O código deve conter HTML, CSS e JavaScript em um único bloco. Use os seguintes marcadores para separar as seções: "<!-- HTML -->", "/* CSS */", e "/* JS */". O código deve ser bem comentado, completo e pronto para uso. Não inclua nenhuma introdução, explicação ou texto de conclusão fora do bloco de código. Apenas o código.`;
                } else {
                    fullPrompt = `Gere um trecho de código em ${selectedLanguage} que faça o seguinte: "${userPrompt}". O código deve ser bem comentado, completo e pronto para uso. Não inclua nenhuma introdução, explicação ou texto de conclusão fora do bloco de código. Apenas o código. Limpe o resultado removendo os marcadores de linguagem como \`\`\`${selectedLanguage} no início e \`\`\` no final.`;
                }
                await generateContentStream(fullPrompt, abortController.signal);
                addToHistory(userPrompt, selectedLanguage);
            } catch (error) {
                if (error.name !== 'AbortError') {
                    codeEditor.textContent = `Ocorreu um erro ao tentar gerar o código. Detalhes: ${error.message}`;
                } else {
                    codeEditor.textContent = 'Geração de código cancelada.';
                }
            } finally {
                setLoadingState(false);
                codePane.classList.remove('hidden');
                skeletonLoader.classList.add('hidden');
                updateStats();
                followUpContainer.classList.remove('hidden');
            }
        }

        async function generateContentStream(prompt, signal, isAction = false) {
            const apiKey = "";
            const modelName = 'gemini-2.5-flash-preview-05-20';
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:streamGenerateContent?key=${apiKey}`;
            const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };

            const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload), signal });
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let buffer = '';

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                buffer += decoder.decode(value, { stream: true });
                let eolIndex;
                while ((eolIndex = buffer.indexOf('\n')) >= 0) {
                    const line = buffer.substring(0, eolIndex).trim();
                    buffer = buffer.substring(eolIndex + 1);
                    if (line.startsWith('data: ')) {
                        try {
                            const jsonStr = line.substring(5).trim();
                            if (jsonStr) {
                                const parsed = JSON.parse(jsonStr);
                                const textPart = parsed.candidates?.[0]?.content?.parts?.[0]?.text;
                                if (textPart) codeEditor.textContent += textPart;
                            }
                        } catch (e) { console.warn("A ignorar um bloco JSON malformado no stream:", line, e); }
                    }
                }
            }
            if (buffer.startsWith('data: ')) {
                try {
                    const jsonStr = buffer.substring(5).trim();
                    if (jsonStr) {
                        const parsed = JSON.parse(jsonStr);
                        const textPart = parsed.candidates?.[0]?.content?.parts?.[0]?.text;
                        if (textPart) codeEditor.textContent += textPart;
                    }
                } catch (e) { console.warn("A ignorar um bloco JSON final malformado:", buffer, e); }
            }
            
            const highlightedCode = hljs.highlight(codeEditor.textContent, { language: isAction ? 'markdown' : languageSelect.value }).value;
            codeEditor.innerHTML = highlightedCode;
        }

        function showCodeView() { codePane.classList.remove('hidden'); previewPane.classList.add('hidden'); previewToggleBtn.textContent = 'Executar Preview'; $('result-title').textContent = 'Código Gerado'; copyBtn.classList.remove('hidden'); downloadBtn.classList.remove('hidden'); }
        function showPreview() { updatePreview(); previewPane.classList.remove('hidden'); codePane.classList.add('hidden'); previewToggleBtn.textContent = 'Ver Código'; $('result-title').textContent = 'Preview'; copyBtn.classList.add('hidden'); downloadBtn.classList.add('hidden'); }
        
        function updatePreview() {
            const code = codeEditor.textContent, language = languageSelect.value;
            let htmlContent = '';
            const buildHtml = (html, css, js) => `<!DOCTYPE html><html><head><style>${css}</style></head><body>${html}<script>${js.replace(/<\/script>/gi, '<\\/script>')}<\/script></body></html>`;
            switch (language) {
                case 'html': htmlContent = code; break;
                case 'javascript': htmlContent = buildHtml('', '', code); break;
                case 'css': htmlContent = `<!DOCTYPE html><html><head><style>body{font-family: sans-serif; padding: 1rem;} ${code}</style></head><body><h1>Preview de CSS</h1><p>Este é um parágrafo de exemplo.</p><button>Botão</button></body></html>`; break;
                case 'web': {
                    const extract = (start, end) => {
                        const s = code.indexOf(start); if (s === -1) return '';
                        const e = end ? code.indexOf(end, s + start.length) : -1;
                        return code.substring(s + start.length, e !== -1 ? e : undefined).trim();
                    };
                    htmlContent = buildHtml(extract('<!-- HTML -->', '/* CSS */'), extract('/* CSS */', '/* JS */'), extract('/* JS */', null));
                    break;
                }
            }
            $('preview-iframe').srcdoc = htmlContent;
        }

        function setLoadingState(isLoading) { generateBtn.classList.toggle('hidden', isLoading); stopBtn.classList.toggle('hidden', !isLoading); }
        function showCopySuccessState() { const copyText = $('copy-text'), checkIcon = $('check-icon'), copyIcon = $('copy-icon'); copyIcon.classList.add('hidden'); checkIcon.classList.remove('hidden'); copyText.textContent = 'Copiado!'; setTimeout(() => { copyIcon.classList.remove('hidden'); checkIcon.classList.add('hidden'); copyText.textContent = 'Copiar'; }, 2000); }
        copyBtn.addEventListener('click', () => { const codeToCopy = codeEditor.textContent; if (!codeToCopy) return; navigator.clipboard.writeText(codeToCopy).then(() => { const copyFeedback = $('copy-feedback'); copyFeedback.classList.remove('opacity-0'); setTimeout(() => copyFeedback.classList.add('opacity-0'), 2000); showCopySuccessState(); }).catch(err => console.error('Falha ao copiar:', err)); });
        
        function toggleTheme() { const isLight = document.body.classList.toggle('light'); localStorage.setItem('theme', isLight ? 'light' : 'dark'); updateThemeIcons(isLight); }
        function loadTheme() { const savedTheme = localStorage.getItem('theme') || 'dark'; const isLight = savedTheme === 'light'; document.body.classList.toggle('light', isLight); updateThemeIcons(isLight); }
        function updateThemeIcons(isLight) { sunIcon.classList.toggle('hidden', isLight); moonIcon.classList.toggle('hidden', !isLight); }

        function loadHistory() { history = JSON.parse(localStorage.getItem('codeGenHistory')) || []; renderHistory(); }
        function addToHistory(prompt, language) { const newEntry = { prompt, language, id: Date.now(), favorite: false }; history.unshift(newEntry); if (history.length > 50) history.pop(); localStorage.setItem('codeGenHistory', JSON.stringify(history)); renderHistory(); }
        function renderHistory() {
            const searchTerm = historySearch.value.toLowerCase();
            const filteredHistory = history.filter(item => item.prompt.toLowerCase().includes(searchTerm));
            historyList.innerHTML = '';
            if (filteredHistory.length === 0) { historyList.innerHTML = `<li class="text-center p-4" style="color: var(--text-secondary)">Nenhum resultado.</li>`; return; }
            filteredHistory.forEach(item => {
                const li = document.createElement('li');
                li.className = 'p-3 border-b flex justify-between items-center'; li.style.borderColor = 'var(--border)';
                li.innerHTML = `<div class="flex-grow cursor-pointer" onclick="useHistoryItem(${item.id})"><div class="font-semibold truncate">${item.prompt}</div><div class="text-sm" style="color: var(--text-secondary)">${item.language}</div></div><button onclick="toggleFavorite(${item.id})" class="p-1 rounded-full hover-bg">${item.favorite ? '<svg class="w-5 h-5 text-amber-400" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" /></svg>' : '<svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M11.48 3.499a.562.562 0 011.04 0l2.125 5.111a.563.563 0 00.475.345h5.364c.518 0 .734.664.348.974l-4.36 3.162a.563.563 0 00-.182.557l1.635 5.028a.563.563 0 01-.84.622l-4.42-3.232a.563.563 0 00-.664 0l-4.42 3.232a.563.563 0 01-.84-.622l1.635-5.028a.563.563 0 00-.182-.557l-4.36-3.162a.563.563 0 01.348-.974h5.364a.563.563 0 00.475-.345L11.48 3.5z" /></svg>'}</button>`;
                historyList.appendChild(li);
            });
        }
        function useHistoryItem(id) { const item = history.find(h => h.id === id); if (item) { promptInput.value = item.prompt; languageSelect.value = item.language; historyPanel.classList.add('translate-x-full'); } }
        function toggleFavorite(id) { const item = history.find(h => h.id === id); if (item) { item.favorite = !item.favorite; localStorage.setItem('codeGenHistory', JSON.stringify(history)); renderHistory(); } }
        function clearHistory() { if (confirm('Tem a certeza que quer limpar o seu histórico?')) { history = []; localStorage.removeItem('codeGenHistory'); renderHistory(); } }
        function suggestIdea() { promptInput.value = suggestions[Math.floor(Math.random() * suggestions.length)]; promptInput.dispatchEvent(new Event('input')); }
        function downloadCode() { const code = codeEditor.textContent; const language = languageSelect.value; const extensionMap = { 'javascript': 'js', 'python': 'py', 'html': 'html', 'css': 'css', 'java': 'java', 'sql': 'sql', 'web': 'html' }; const extension = extensionMap[language] || 'txt'; const filename = `codigo-gerado.${extension}`; const blob = new Blob([code], { type: 'text/plain' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = filename; a.click(); URL.revokeObjectURL(url); }
        function startSpeechRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) { alert("O reconhecimento de voz não é suportado neste navegador."); return; }
            const recognition = new SpeechRecognition();
            recognition.lang = 'pt-BR';
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;
            micBtn.classList.add('text-red-500');
            recognition.start();
            recognition.onresult = (event) => { promptInput.value = event.results[0][0].transcript; promptInput.dispatchEvent(new Event('input')); };
            recognition.onspeechend = () => { recognition.stop(); micBtn.classList.remove('text-red-500'); };
            recognition.onerror = (event) => { alert(`Erro no reconhecimento de voz: ${event.error}`); micBtn.classList.remove('text-red-500'); };
        }
        function updateStats() { const code = codeEditor.textContent; const lineCount = code.split('\n').length; const charCount = code.length; statsBar.textContent = `Linhas: ${lineCount} | Caracteres: ${charCount}`; }
    </script>
</body>
</html>
