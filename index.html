<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Código com IA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500;700&display=swap" rel="stylesheet">
    <link id="hljs-theme" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/obsidian.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <style>
        :root {
            --bg: #0D0D0D; --panel-bg: #1A1A1A; --border: #333333;
            --text-primary: #00FF41; --text-secondary: #999999; --accent: #00FF41;
        }
        body.light {
            --bg: #FFFFFF; --panel-bg: #F2F2F2; --border: #CCCCCC;
            --text-primary: #000000; --text-secondary: #666666; --accent: #0052ff;
        }
        body { font-family: 'Fira Code', monospace; background-color: var(--bg); color: var(--text-primary); }
        .panel { background-color: var(--panel-bg); border-color: var(--border); }
        .input-area { background-color: var(--bg); border-color: var(--border); }
        .text-secondary { color: var(--text-secondary); }
        .hover-bg:hover { background-color: rgba(0, 255, 65, 0.1); }
        body.light .hover-bg:hover { background-color: rgba(0, 82, 255, 0.1); }
        
        /* Efeito de Scanline para o tema escuro */
        .scanline { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; pointer-events: none; background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.2) 50%, rgba(0,0,0,0.2)); background-size: 100% 4px; animation: scan 0.2s linear infinite; }
        @keyframes scan { from { background-position: 0 0; } to { background-position: 0 4px; } }
        body.light .scanline { display: none; }
        
        /* Scrollbar customizada */
        pre::-webkit-scrollbar { width: 8px; }
        pre::-webkit-scrollbar-track { background: transparent; }
        pre::-webkit-scrollbar-thumb { background-color: var(--accent); }
        
        /* Estilo do Select */
        select { -webkit-appearance: none; -moz-appearance: none; appearance: none; background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%2300FF41' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); background-position: right 0.75rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em; padding-right: 2.5rem; }
        body.light select { background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%23000000' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); }
        select option, select optgroup { background: var(--bg); color: var(--text-primary); }
        
        /* Cursor piscando */
        .blinking-cursor { animation: blink 1s step-end infinite; }
        @keyframes blink { 50% { opacity: 0; } }

        /* Correção para visibilidade do código no highlight.js */
        #code-output.hljs {
            color: #d0d0d0;
            background: transparent;
        }
        body.light #code-output.hljs {
            color: #24292e;
        }
    </style>
</head>
<body class="antialiased transition-colors duration-300">
    <div class="scanline"></div>
    <div class="flex flex-col md:flex-row h-screen">
        <!-- PAINEL DE CONTROLO (ESQUERDA) -->
        <aside class="w-full md:w-80 lg:w-96 flex flex-col p-4 space-y-4 panel border-t-0 border-l-0 border-b-0 md:border-r">
            <header class="flex justify-between items-center flex-shrink-0">
                <h1 class="text-xl font-bold">[user@codegen ~]$</h1>
            </header>

            <div class="flex-grow flex flex-col space-y-4">
                <div>
                    <label for="language" class="block text-sm font-medium mb-2 text-secondary">> Linguagem</label>
                    <select id="language" class="w-full text-base input-area rounded-none px-4 py-2 focus:ring-1 focus:ring-green-500 focus:outline-none transition">
                       <optgroup label="Web"><option value="web">HTML/CSS/JS</option><option value="html">HTML</option><option value="css">CSS</option><option value="javascript">JavaScript</option></optgroup>
                       <optgroup label="Back-end"><option value="python">Python</option><option value="java">Java</option><option value="go">Go</option><option value="php">PHP</option><option value="ruby">Ruby</option></optgroup>
                       <optgroup label="Base de Dados"><option value="sql">SQL</option></optgroup>
                    </select>
                </div>
                <div class="flex-grow flex flex-col">
                    <div class="flex justify-between items-center mb-2">
                        <label for="prompt" class="text-sm font-medium text-secondary">> Pedido</label>
                        <button id="suggest-btn" title="Sugerir uma ideia com IA" class="text-secondary hover:text-primary transition disabled:opacity-50 disabled:cursor-wait">[Sugerir]</button>
                    </div>
                    <div class="relative w-full h-full flex-grow">
                        <textarea id="prompt" rows="4" class="w-full h-full flex-grow text-base input-area rounded-none px-4 py-2 focus:ring-1 focus:ring-green-500 focus:outline-none transition resize-none" placeholder="..."></textarea>
                        <span id="blinking-cursor" class="blinking-cursor absolute top-2.5 left-4 text-base pointer-events-none">_</span>
                    </div>
                </div>
                <div class="pt-2 flex-shrink-0">
                    <button id="generate-btn" class="w-full border-2 font-bold py-3 px-4 transition-all duration-300 flex items-center justify-center disabled:opacity-50" style="border-color: var(--accent); color: var(--accent);" onmouseover="this.style.backgroundColor=getComputedStyle(this).getPropertyValue('--accent'); this.style.color=getComputedStyle(this).getPropertyValue('--bg')" onmouseout="this.style.backgroundColor='transparent'; this.style.color=getComputedStyle(this).getPropertyValue('--accent')">
                        <svg id="button-icon" class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M5.25 5.653c0-.856.917-1.398 1.667-.986l11.54 6.348a1.125 1.125 0 010 1.971l-11.54 6.347a1.125 1.125 0 01-1.667-.985V5.653z" /></svg>
                        <span id="button-text">Executar</span>
                    </button>
                </div>
            </div>
            <footer class="flex-shrink-0 flex items-center justify-center space-x-2">
                 <button id="settings-toggle-btn" class="p-2 rounded-full hover-bg transition"><svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 011.37.49l1.296 2.247a1.125 1.125 0 01-.26 1.431l-1.003.827c-.293.24-.438.613-.438.995s.145.755.438.995l1.003.827c.446.368.52.98.26 1.431l-1.296 2.247a1.125 1.125 0 01-1.37.49l-1.217-.456c-.355-.133-.75-.072-1.075.124a6.57 6.57 0 01-.22.127c-.331.183-.581.495-.645.87l-.213 1.281c-.09.543-.56.94-1.11.94h-2.593c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.063-.374-.313-.686-.645-.87a6.52 6.52 0 01-.22-.127c-.324-.196-.72-.257-1.075-.124l-1.217.456a1.125 1.125 0 01-1.37-.49l-1.296-2.247a1.125 1.125 0 01.26-1.431l1.004-.827c.292-.24.437-.613.437-.995s-.145-.755-.437-.995l-1.004-.827a1.125 1.125 0 01-.26-1.431l1.296-2.247a1.125 1.125 0 011.37-.49l1.217.456c.355.133.75.072 1.075-.124.072-.044.146-.087.22-.127.332-.183.582-.495.645-.87l.213-1.281z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg></button>
                 <button id="theme-toggle-btn" class="p-2 rounded-full hover-bg transition"><svg id="sun-icon" class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" /></svg><svg id="moon-icon" class="w-5 h-5 hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25c0 5.385 4.365 9.75 9.75 9.75 2.597 0 4.962-.992 6.75-2.625z" /></svg></button>
                 <button id="history-toggle-btn" class="p-2 rounded-full hover-bg transition"><svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></button>
            </footer>
        </aside>

        <!-- ÁREA DE CONTEÚDO (DIREITA) -->
        <main id="main-content" class="flex-1 flex flex-col overflow-hidden">
            <!-- PAINEL DE PLACEHOLDER -->
            <div id="placeholder-panel" class="w-full h-full flex items-center justify-center panel rounded-none">
                <div class="text-center text-secondary">
                    <svg class="w-16 h-16 mx-auto mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M17.25 6.75L22.5 12l-5.25 5.25m-10.5 0L1.5 12l5.25-5.25m7.5-3l-4.5 16.5" /></svg>
                    <h2 class="text-xl font-medium">A aguardar comando...</h2>
                </div>
            </div>

            <!-- PAINEL DE CÓDIGO -->
            <div id="code-panel" class="w-full h-full flex flex-col panel border-r hidden">
                <div class="px-6 py-4 border-b border-color flex justify-between items-center flex-shrink-0">
                    <h2 class="text-lg font-semibold">Código</h2>
                    <div class="flex items-center space-x-2">
                        <button id="toggle-preview-btn" class="text-sm font-medium py-2 px-4 rounded-lg transition-colors flex items-center hover-bg hidden">Executar Preview</button>
                        <button id="copy-btn" class="text-sm font-medium py-2 px-4 rounded-lg transition-colors flex items-center hover-bg">
                            <span id="copy-icon"><svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 7.5V6.108c0-1.135.845-2.098 1.976-2.192.373-.03.748-.03 1.125 0 1.131.094 1.976 1.057 1.976 2.192V7.5m-9 3c0-1.135.845-2.098 1.976-2.192a48.424 48.424 0 011.125 0c1.131.094 1.976 1.057 1.976 2.192V19.5A2.25 2.25 0 0118 21.75V10.5M15 12H9m12 3h-2.25M15 12H9" /></svg></span>
                            <span id="check-icon" class="hidden"><svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg></span>
                            <span id="copy-text" class="ml-2">Copiar</span>
                        </button>
                    </div>
                </div>
                <div class="flex-grow h-0"><pre class="w-full h-full"><code id="code-output" class="w-full h-full p-6 block overflow-auto outline-none"></code></pre></div>
            </div>

            <!-- PAINEL DE PREVIEW -->
            <div id="preview-panel" class="w-full h-full flex-col bg-white hidden">
                <div class="px-6 py-4 border-b border-color flex justify-between items-center flex-shrink-0 panel">
                    <h2 class="text-lg font-semibold">Preview</h2>
                    <button id="show-code-btn" class="text-sm font-medium py-2 px-4 rounded-lg transition-colors flex items-center hover-bg">Mostrar Código</button>
                </div>
                <div class="flex-grow h-0"><iframe id="preview-iframe" class="w-full h-full border-none"></iframe></div>
            </div>
        </main>
    </div>

    <!-- PAINEL LATERAL (HISTÓRICO E CONFIGURAÇÕES) -->
    <div id="side-panel-container" class="fixed top-0 right-0 h-full w-80 md:w-96 panel shadow-2xl transform translate-x-full transition-transform duration-300 ease-in-out z-20 flex flex-col">
        <div id="history-panel">
            <div class="p-4 border-b border-color flex justify-between items-center"><h3 class="text-lg font-semibold">Histórico</h3><button id="close-side-panel-btn"><svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg></button></div>
            <div class="p-2"><input id="history-search" type="search" placeholder="Pesquisar histórico..." class="w-full text-sm input-area rounded-none px-3 py-1.5 focus:ring-1 focus:ring-green-500 focus:outline-none transition"></div>
            <ul id="history-list" class="flex-grow overflow-y-auto p-2" style="max-height: calc(100vh - 180px);"></ul>
            <div class="p-4 border-t border-color"><button id="clear-history-btn" class="w-full border-2 border-red-500 text-red-500 font-bold py-2 px-4 transition hover:bg-red-500 hover:text-white">Limpar Histórico</button></div>
        </div>
        <div id="settings-panel" class="hidden">
            <div class="p-4 border-b border-color flex justify-between items-center"><h3 class="text-lg font-semibold">Configurações</h3><button id="close-settings-btn"><svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg></button></div>
            <div class="p-4 space-y-4">
                <label for="api-key-input" class="block text-sm font-medium text-secondary">Chave de API do Gemini</label>
                <input type="password" id="api-key-input" class="w-full text-base input-area rounded-none px-4 py-2 focus:ring-1 focus:ring-green-500 focus:outline-none transition">
                <button id="save-api-key-btn" class="w-full border-2 font-bold py-2 px-4" style="border-color: var(--accent); color: var(--accent);" onmouseover="this.style.backgroundColor=getComputedStyle(this).getPropertyValue('--accent'); this.style.color=getComputedStyle(this).getPropertyValue('--bg')" onmouseout="this.style.backgroundColor='transparent'; this.style.color=getComputedStyle(this).getPropertyValue('--accent')">Guardar Chave</button>
                <p class="text-xs text-secondary">A sua chave é guardada apenas no seu navegador. <a href="https://aistudio.google.com/app/apikey" target="_blank" class="hover:underline" style="color: var(--accent);">Obtenha uma chave aqui.</a></p>
            </div>
        </div>
    </div>

    <!-- FEEDBACK DE CÓPIA -->
    <div id="copy-feedback" class="fixed bottom-5 right-5 py-2 px-4 rounded-md shadow-lg opacity-0 transition-opacity duration-500" style="background-color: var(--accent); color: var(--bg);">Código copiado!</div>

    <!-- MODAL PARA NOTIFICAÇÕES -->
    <div id="modal-container" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
        <div class="panel p-6 rounded-lg shadow-xl w-full max-w-md text-center">
            <p id="modal-text" class="mb-6 text-lg"></p>
            <div id="modal-buttons" class="flex justify-center space-x-4">
                 <button id="modal-ok-btn" class="border-2 font-bold py-2 px-8 transition-colors duration-300" style="border-color: var(--accent); color: var(--accent);" onmouseover="this.style.backgroundColor=getComputedStyle(this).getPropertyValue('--accent'); this.style.color=getComputedStyle(this).getPropertyValue('--bg')" onmouseout="this.style.backgroundColor='transparent'; this.style.color=getComputedStyle(this).getPropertyValue('--accent')">OK</button>
                 <button id="modal-cancel-btn" class="text-secondary py-2 px-8 transition-colors hover:text-primary">Cancelar</button>
            </div>
        </div>
    </div>

    <script>
        // Mapeamento de Elementos do DOM
        const $ = (selector) => document.getElementById(selector);
        const elements = {
            generateBtn: $('generate-btn'), promptInput: $('prompt'), languageSelect: $('language'),
            codeOutput: $('code-output'), copyBtn: $('copy-btn'),
            togglePreviewBtn: $('toggle-preview-btn'), codePanel: $('code-panel'), previewPanel: $('preview-panel'),
            showCodeBtn: $('show-code-btn'),
            themeToggleBtn: $('theme-toggle-btn'), sunIcon: $('sun-icon'), moonIcon: $('moon-icon'),
            sidePanelContainer: $('side-panel-container'), historyPanel: $('history-panel'), settingsPanel: $('settings-panel'),
            historyToggleBtn: $('history-toggle-btn'), settingsToggleBtn: $('settings-toggle-btn'),
            closeSidePanelBtn: $('close-side-panel-btn'), closeSettingsBtn: $('close-settings-btn'),
            historyList: $('history-list'), clearHistoryBtn: $('clear-history-btn'), historySearch: $('history-search'),
            suggestBtn: $('suggest-btn'), apiKeyInput: $('api-key-input'), saveApiKeyBtn: $('save-api-key-btn'),
            placeholderPanel: $('placeholder-panel'), blinkingCursor: $('blinking-cursor'),
            copyFeedback: $('copy-feedback'), copyIcon: $('copy-icon'), checkIcon: $('check-icon'), copyText: $('copy-text'),
            buttonIcon: $('button-icon'), buttonText: $('button-text'), previewIframe: $('preview-iframe'),
            modalContainer: $('modal-container'), modalText: $('modal-text'), modalButtons: $('modal-buttons'),
            modalOkBtn: $('modal-ok-btn'), modalCancelBtn: $('modal-cancel-btn')
        };

        // Estado da Aplicação
        let rawCode = '';
        let history = [];
        const webLanguages = ['html', 'javascript', 'css', 'web'];

        // Funções do Modal
        let modalResolve = null;
        const showModal = (message, type = 'alert') => {
            return new Promise(resolve => {
                modalResolve = resolve;
                elements.modalText.textContent = message;
                elements.modalCancelBtn.style.display = type === 'confirm' ? 'inline-block' : 'none';
                elements.modalContainer.classList.remove('hidden');
            });
        };
        const closeModal = (result) => {
            elements.modalContainer.classList.add('hidden');
            if (modalResolve) {
                modalResolve(result);
                modalResolve = null;
            }
        };

        // Funções de UI
        const setLoadingState = (isLoading) => {
            elements.generateBtn.disabled = isLoading;
            elements.buttonText.textContent = isLoading ? 'A Gerar...' : 'Executar';
            isLoading ? elements.buttonIcon.classList.add('animate-spin') : elements.buttonIcon.classList.remove('animate-spin');
        };

        const showCopySuccessState = () => {
            elements.copyIcon.classList.add('hidden');
            elements.checkIcon.classList.remove('hidden');
            elements.copyText.textContent = 'Copiado!';
            elements.copyFeedback.classList.remove('opacity-0');
            setTimeout(() => {
                elements.copyIcon.classList.remove('hidden');
                elements.checkIcon.classList.add('hidden');
                elements.copyText.textContent = 'Copiar';
                elements.copyFeedback.classList.add('opacity-0');
            }, 2000);
        };

        const toggleTheme = () => {
            const isLight = document.body.classList.toggle('light');
            localStorage.setItem('theme', isLight ? 'light' : 'dark');
            updateThemeUI(isLight);
        };

        const loadTheme = () => {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            const isLight = savedTheme === 'light';
            document.body.classList.toggle('light', isLight);
            updateThemeUI(isLight);
        };

        const updateThemeUI = (isLight) => {
            elements.sunIcon.classList.toggle('hidden', isLight);
            elements.moonIcon.classList.toggle('hidden', !isLight);
            const themeUrl = isLight
                ? 'https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css'
                : 'https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/obsidian.min.css';
            $('hljs-theme').setAttribute('href', themeUrl);
        };

        const showSidePanel = (panelToShow) => {
            elements.historyPanel.classList.toggle('hidden', panelToShow !== 'history');
            elements.settingsPanel.classList.toggle('hidden', panelToShow !== 'settings');
            if (panelToShow === 'settings') {
                elements.apiKeyInput.value = localStorage.getItem('geminiApiKey') || '';
            }
            elements.sidePanelContainer.classList.remove('translate-x-full');
        };

        const hideSidePanel = () => {
            elements.sidePanelContainer.classList.add('translate-x-full');
        };
        
        // Funções de Histórico
        const loadHistory = () => {
            history = JSON.parse(localStorage.getItem('codeGenHistory')) || [];
            renderHistory();
        };

        const addToHistory = (prompt, language) => {
            const newEntry = { prompt, language, id: Date.now() };
            history.unshift(newEntry);
            if (history.length > 50) history.pop();
            localStorage.setItem('codeGenHistory', JSON.stringify(history));
            renderHistory();
        };

        const renderHistory = () => {
            const searchTerm = elements.historySearch.value.toLowerCase();
            const filteredHistory = history.filter(item => item.prompt.toLowerCase().includes(searchTerm));
            elements.historyList.innerHTML = '';
            if (filteredHistory.length === 0) {
                elements.historyList.innerHTML = `<li class="text-center p-4 text-secondary">Nenhum resultado.</li>`;
                return;
            }
            filteredHistory.forEach(item => {
                const li = document.createElement('li');
                li.className = 'p-3 border-b border-color cursor-pointer hover-bg rounded transition-colors';
                li.innerHTML = `<div class="font-semibold truncate">${item.prompt}</div><div class="text-sm text-secondary">${item.language}</div>`;
                li.onclick = () => {
                    elements.promptInput.value = item.prompt;
                    elements.languageSelect.value = item.language;
                    hideSidePanel();
                };
                elements.historyList.appendChild(li);
            });
        };

        const clearHistory = async () => {
            const confirmed = await showModal('Tem a certeza que quer limpar o seu histórico?', 'confirm');
            if (confirmed) {
                history = [];
                localStorage.removeItem('codeGenHistory');
                renderHistory();
            }
        };
        
        // Funções Principais
        const handleGenerateClick = async () => {
            const userPrompt = elements.promptInput.value.trim();
            const selectedLanguage = elements.languageSelect.value;
            const apiKey = localStorage.getItem('geminiApiKey');

            if (!apiKey) {
                await showModal('Por favor, configure a sua chave de API do Gemini nas configurações.');
                showSidePanel('settings');
                return;
            }
            if (!userPrompt) {
                await showModal('Por favor, descreva o que o código deve fazer.');
                return;
            }
            
            setLoadingState(true);
            elements.placeholderPanel.classList.add('hidden');
            elements.codePanel.classList.remove('hidden');
            elements.previewPanel.classList.add('hidden');
            elements.codeOutput.textContent = 'A gerar código...';

            const isWeb = webLanguages.includes(selectedLanguage);
            elements.togglePreviewBtn.classList.toggle('hidden', !isWeb);

            try {
                let fullPrompt;
                if (selectedLanguage === 'web') {
                    fullPrompt = `Crie um trecho de código web completo que faça o seguinte: "${userPrompt}". O código deve conter HTML, CSS e JavaScript em um único bloco. Use os seguintes marcadores para separar as seções: "<!-- HTML -->", "/* CSS */", e "/* JS */". O código deve ser bem comentado, completo e pronto para uso. Não inclua nenhuma introdução, explicação ou texto de conclusão fora do bloco de código. Apenas o código.`;
                } else {
                    fullPrompt = `Gere um trecho de código em ${selectedLanguage} que faça o seguinte: "${userPrompt}". O código deve ser bem comentado, completo e pronto para uso. Não inclua nenhuma introdução, explicação ou texto de conclusão fora do bloco de código. Apenas o código. Limpe o resultado removendo os marcadores de linguagem como \`\`\`${selectedLanguage} no início e \`\`\` no final.`;
                }
                rawCode = await generateContent(fullPrompt, apiKey);
                elements.codeOutput.textContent = rawCode;
                hljs.highlightElement(elements.codeOutput);
                addToHistory(userPrompt, selectedLanguage);

            } catch (error) {
                console.error('Erro ao gerar o código:', error);
                elements.codeOutput.textContent = `Ocorreu um erro ao tentar gerar o código. Detalhes: ${error.message}`;
                await showModal(`Ocorreu um erro: ${error.message}`);
            } finally {
                setLoadingState(false);
            }
        };
        
        const getAISuggestion = async () => {
            const apiKey = localStorage.getItem('geminiApiKey');
            if (!apiKey) {
                await showModal('Por favor, configure a sua chave de API para usar sugestões da IA.');
                showSidePanel('settings');
                return;
            }

            const originalText = elements.suggestBtn.textContent;
            elements.suggestBtn.textContent = "[A pensar...]";
            elements.suggestBtn.disabled = true;

            const suggestionPrompt = "Sugira uma ideia criativa e concisa para um pequeno projeto de programação ou um snippet de código. A ideia deve ser adequada para um desenvolvedor iniciante a intermediário. Responda com a ideia em uma única frase curta, sem aspas, introdução ou texto extra. Por exemplo: um seletor de cores com visualização em tempo real";

            try {
                const suggestion = await generateContent(suggestionPrompt, apiKey);
                elements.promptInput.value = suggestion.trim().replace(/^"|"$/g, ''); // Remove aspas
                elements.promptInput.dispatchEvent(new Event('input'));
            } catch (error) {
                console.error("Erro ao obter sugestão da IA:", error);
                await showModal("Não foi possível obter uma sugestão da IA. Tente novamente.");
                elements.promptInput.value = "uma calculadora simples"; // Fallback
            } finally {
                elements.suggestBtn.textContent = originalText;
                elements.suggestBtn.disabled = false;
            }
        };

        const generateContent = async (prompt, apiKey) => {
            const modelName = 'gemini-2.5-flash-preview-05-20';
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`;
            const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };

            const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error?.message || `HTTP error! status: ${response.status}`);
            }
            
            const result = await response.json();
            const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
            if (text) return text;
            
            throw new Error("Não foi possível obter uma resposta válida da API.");
        };

        const updatePreview = () => {
            const code = rawCode;
            const language = elements.languageSelect.value;
            let htmlContent = '';
            const buildHtml = (html, css, js) => `<!DOCTYPE html><html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><style>${css}</style></head><body>${html}<script>${js.replace(/<\/script>/gi, '<\\/script>')}<\/script></body></html>`;
            
            switch (language) {
                case 'html': 
                    htmlContent = code; 
                    break;
                case 'javascript': 
                    htmlContent = buildHtml('', '', code); 
                    break;
                case 'css': 
                    htmlContent = `<!DOCTYPE html><html><head><style>body{font-family: sans-serif; padding: 1rem;} ${code}</style></head><body><h1>Preview de CSS</h1><p>Este é um parágrafo de exemplo.</p><button>Botão</button></body></html>`; 
                    break;
                case 'web': {
                    const extract = (start, end) => {
                        const s = code.indexOf(start);
                        if (s === -1) return '';
                        const e = end ? code.indexOf(end, s + start.length) : -1;
                        return code.substring(s + start.length, e !== -1 ? e : undefined).trim();
                    };
                    const html = extract('<!-- HTML -->', '/* CSS */');
                    const css = extract('/* CSS */', '/* JS */');
                    const js = extract('/* JS */', null);

                    // Fallback: Se não encontrar os marcadores, assume que o código inteiro é HTML.
                    if (!html && !css && !js) {
                        htmlContent = code; 
                    } else {
                        htmlContent = buildHtml(html, css, js);
                    }
                    break;
                }
            }
            elements.previewIframe.srcdoc = htmlContent;
        };

        const saveApiKey = async () => {
            const key = elements.apiKeyInput.value.trim();
            if (key) {
                localStorage.setItem('geminiApiKey', key);
                await showModal('Chave de API guardada com sucesso!');
                hideSidePanel();
            } else {
                await showModal('Por favor, insira uma chave de API válida.');
            }
        };

        // Event Listeners
        const setupEventListeners = () => {
            elements.generateBtn.addEventListener('click', handleGenerateClick);
            
            elements.togglePreviewBtn.addEventListener('click', () => {
                updatePreview();
                elements.codePanel.classList.add('hidden');
                elements.previewPanel.classList.remove('hidden');
            });

            elements.showCodeBtn.addEventListener('click', () => {
                elements.previewPanel.classList.add('hidden');
                elements.codePanel.classList.remove('hidden');
            });

            elements.themeToggleBtn.addEventListener('click', toggleTheme);
            elements.historyToggleBtn.addEventListener('click', () => showSidePanel('history'));
            elements.settingsToggleBtn.addEventListener('click', () => showSidePanel('settings'));
            elements.closeSidePanelBtn.addEventListener('click', hideSidePanel);
            elements.closeSettingsBtn.addEventListener('click', hideSidePanel);
            elements.clearHistoryBtn.addEventListener('click', clearHistory);
            elements.suggestBtn.addEventListener('click', getAISuggestion);
            elements.historySearch.addEventListener('input', renderHistory);
            elements.saveApiKeyBtn.addEventListener('click', saveApiKey);
            elements.promptInput.addEventListener('input', () => {
                elements.blinkingCursor.classList.toggle('hidden', elements.promptInput.value.length > 0);
            });
            elements.copyBtn.addEventListener('click', () => {
                if (!rawCode) return;
                navigator.clipboard.writeText(rawCode).then(showCopySuccessState).catch(err => console.error('Falha ao copiar:', err));
            });
            elements.modalOkBtn.addEventListener('click', () => closeModal(true));
            elements.modalCancelBtn.addEventListener('click', () => closeModal(false));
        };

        // Inicialização
        document.addEventListener('DOMContentLoaded', () => {
            loadTheme();
            loadHistory();
            setupEventListeners();
        });
    </script>
</body>
</html>
